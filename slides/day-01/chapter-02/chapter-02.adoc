== Clock Synchronization in CockroachDB

=== ! 

[.h4-style]
Clock synchronization is crucial for maintaining data consistency in distributed databases

=== Why Clock Synch Matters

* CockroachDB relies on accurate timestamps for transaction ordering and conflict resolution
* Clock skew beyond 500ms can cause node shutdown to preserve data integrity
* Accurate time synchronization prevents transaction anomalies and ensures reliable operations
* NTP (Network Time Protocol) is a networking protocol used to synchronize the clocks of computers over variable-latency distributed networks. 
** Proper NTP configuration is a fundamental requirement for production deployments

[.notes]
--
Clock synchronization is not just a technical requirement but a fundamental necessity for distributed databases like CockroachDB. The database uses Hybrid Logical Clocks (HLC), which combine physical time (as reported by the node’s clock) with logical time (to handle increments when the clock doesn’t change). This mechanism ensures that transactions are correctly ordered even in the presence of clock skew.

However, if the clock drift across nodes exceeds the 500ms threshold, CockroachDB will proactively shut down the affected node rather than risk data inconsistency. This is a safety feature designed to maintain correctness above all else. In practice, you want to keep skew well under 100ms in production. Proper clock synchronization is therefore vital to avoid transaction ordering issues and anomalies such as write-write conflicts that cannot be properly resolved.
--


=== Understanding Network Time Protocol

* NTP uses hierarchical system of time servers organized in stratum levels
** Stratum 1 servers directly connected to atomic clocks or GPS time sources
** Lower stratum numbers indicate more accurate time sources
* NTP continuously adjusts local system time to match reference servers
* Time synchronization occurs gradually to prevent sudden clock jumps

[.notes]
--
NTP is an industry-standard protocol to keep system time accurate within milliseconds of a trusted source. 

A few points to remember:
- *Stratum 1* servers are directly connected to a hardware clock source (e.g., an atomic clock or GPS-based time signals).
- Each successive stratum level (2, 3, etc.) synchronizes with the level above, adding some offset and latency in the process.
- NTP’s continuous synchronization approach increments or decrements time slowly (referred to as slewing) instead of doing abrupt clock changes. This avoids sudden jumps that might disrupt running processes, especially in a distributed database environment.

Below is a simple example of checking NTP status using the `ntpq` utility:

[source,bash]
----
ntpq -p
----

This output will list servers, their stratum levels, offsets, delay, and jitter. A ‘*’ next to a server indicates it's the primary reference source.
--

=== Configuring NTP for CockroachDB

* Choose reliable NTP servers with good geographical proximity
* Configure multiple NTP servers for redundancy and accuracy
* Public NTP services (like Google's) provide reliable, accessible time sources

[.notes]
--
When configuring NTP for CockroachDB:
- Select servers that are close to your geographic location or your data center to minimize network latency and jitter.
- Use at least 3–4 servers to achieve redundancy and a good consensus on accurate time. 
- Google’s public NTP servers (time1.google.com through time4.google.com) are popular and reliable choices, but other providers (like pool.ntp.org) are also widely used.

A sample `/etc/ntp.conf` snippet might look like this:

[source,conf]
----
server time1.google.com iburst
server time2.google.com iburst
server time3.google.com iburst
server time4.google.com iburst
----

The `iburst` option speeds up the initial synchronization when the service first starts.
--

=== Monitoring Clock Synchronization Goals

* Regular monitoring of NTP status prevents drift-related issues
* Time offset should be maintained well under 100ms for optimal operation

[.notes]
--
When configuring NTP for CockroachDB:

- Monitor NTP status regularly to ensure time offset remains within safe bounds, ideally well under 100ms.
--

=== Monitoring Clock Synchronization Tools

* Use `ntpq -p` to check synchronization status and server selection
** Monitor the offset column to ensure minimal time difference
** Watch for the '*' indicator showing the selected time source
* Check `ntpq -c rl` to verify NTP synchronization state
** Look for warning indicators like `leap_alarm` or `sync_unspec`

[.notes]
--
Monitoring is critical to keep your node’s time within acceptable limits for CockroachDB. Commonly used commands:

1. `ntpq -p`: Displays a table of peers, offset, delay, and jitter. The `offset` value should be as low as possible, usually a few milliseconds. An example output might look like:

[source,bash]
----
$ ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*time1.google .GOOG.           1 u  34   64  377    0.680   -0.012   0.001
+time2.google .GOOG.           1 u  34   64  377    0.710   -0.015   0.002
----

   - `*` indicates the currently chosen synchronization source.
   - `+` or other symbols may indicate additional servers available for failover.

2. `ntpq -c rl`: Provides the system status, including the system peer, stratum, and leap indicator. Look out for `leap_alarm` or `sync_unspec`, which suggest the clock might not be correctly synchronized. If you see these warnings, investigate immediately.

Keeping an eye on these metrics helps ensure that the underlying system clock meets CockroachDB’s strict timing requirements.
--

=== Summary

* Clock synchronization is critical for CockroachDB's operation
* NTP provides reliable time synchronization across distributed systems
* Proper configuration and monitoring prevent timing-related issues
* Time offset should remain well under 100ms
* Regular validation ensures continued proper operation

[.notes]
--
Key points:
- CockroachDB depends on accurate clocks across all nodes to manage transaction ordering via Hybrid Logical Clocks.
- NTP is the de facto standard for time synchronization. Configuring multiple, geographically proximate servers enhances accuracy and redundancy.
- Monitoring and regularly verifying your synchronization status with tools like `ntpq` and logs is paramount.
- A time offset significantly beyond 100ms can risk transaction anomalies; beyond 500ms, nodes may shut down.
- Continuous diligence in time synchronization is a cornerstone of reliable and consistent CockroachDB deployments.
--

=== Introduction to the Exercise

* Configure NTP using Google's public time servers
* Validate proper synchronization using monitoring tools
* Interpret synchronization metrics and status indicators
* Verify clock offset remains within acceptable limits
* Ensure CockroachDB's time requirements are met

[.notes]
--
In this exercise, you will:
1. Update your `/etc/ntp.conf` to include Google’s time servers.
2. Confirm that your system is synchronizing properly by using `ntpq -p` and interpreting values like offset, delay, and jitter.
3. Explore additional commands like `ntpq -c rl` to verify the synchronization state.
4. Cross-check that your clock offset remains well below 100ms to maintain CockroachDB’s optimal operating conditions.

This hands-on setup will reinforce how essential clock synchronization is for distributed systems. Verifying it thoroughly now prevents issues that can manifest as transaction ordering errors or node shutdowns.
--

