== Encryption at Rest in CockroachDB
=== Why Encryption at Rest Matters
[.text-left]
* Protects sensitive data stored on disk
* Prevents unauthorized access to data files
* Complies with security regulations and standards
* Guards against physical theft of storage media
* Essential for enterprise data protection

[.notes]
--
Encryption at rest is a critical security feature that protects data stored on
disk from unauthorized access. Without encryption, sensitive data in storage
files might be readable by anyone with physical access to the storage media.
This feature is essential for compliance with security regulations (e.g., GDPR,
HIPAA) and for mitigating data breach risks stemming from stolen or
decommissioned hardware.

In CockroachDB, encryption at rest provides an additional layer of security on
top of any network-level encryption (TLS) you may have configured. It ensures
that data is unreadable if someone gains physical access to the underlying disk.
Many organizations consider encryption at rest a best practice or mandatory
requirement for enterprise environments.
--

=== Understanding Unencrypted Storage
[.text-left]
* Data stored in SST files and logs
* Files contain readable string patterns
* Binary encoding provides minimal protection
* Direct file access reveals sensitive data
* Demonstrates need for encryption

[.notes]
--
In an unencrypted CockroachDB deployment, data is stored in SST (Sorted String
Table) files and logs on disk. Although these files are in a binary format,
simple command-line tools like `strings` and `grep` can still reveal sensitive
information (for example, user emails, passwords, or credit card numbers) if
they appear as readable text.

This lack of protection is especially concerning if disks are misplaced, stolen,
or improperly destroyed. Attackers with direct access to the files can extract
confidential data. This vulnerability clearly demonstrates why encryption at
rest is a must for securing sensitive workloads.
--

=== Implementing Encryption
[.text-left]
* Generate AES encryption keys (128/256-bit)
* Distribute keys to all cluster nodes
* Configure encryption parameters
* Restart nodes with encryption enabled
* Verify encryption status

[.notes]
--
CockroachDB’s encryption at rest relies on AES keys, which can be either 128-bit or 256-bit. A common workflow includes:

1. **Generate a Key**  
   You can use CockroachDB’s built-in key generation:
+
[source,bash]
----
cockroach gen encryption-key --size=128 \
   --enterprise-encryption-key=path/to/aes-128.key
----
+
Or use another secure method (like OpenSSL) to produce a key.

2. **Distribute the Key Securely**  
   Copy the generated key file to each node in your cluster, ensuring secure transfer. Set strict file permissions (e.g., `chmod 600`) so only the CockroachDB process can read it.

3. **Configure Encryption Settings**  
   Start each node with the appropriate flags:
+
[source,bash]
----
cockroach start \
--enterprise-encryption=path=/path/to/aes-128.key,key=/path/to/aes-128.key,old-key=\
--store=/path/to/store \
--certs-dir=/path/to/certs
----
+
The `old-key` parameter can be omitted if there’s no previous key in use.

4. **Restart the Nodes**  
   After adding these flags, restart each node so that new writes are encrypted.

5. **Verify Encryption Status**  
   Use `cockroach debug encryption-status` or check the Admin API to confirm that encryption is active. You can also inspect the logs for relevant messages indicating that encryption is enabled.

Newly written SSTs and logs are now encrypted at rest, protecting your data from unauthorized disk access.
--

=== Encryption Key Management
[.text-left]
* Secure key generation and storage
* Proper file permissions (chmod 600)
* Safe key distribution across nodes
* Regular key rotation practices
* Monitoring encryption status

[.notes]
--

Robust key management is fundamental to maintaining a secure encrypted environment:

1. **Generation**  
   Always generate keys using a secure, trusted mechanism. Store the original key file in a password-protected or access-controlled vault if possible.

2. **Permissions**  
   Set file ownership to the CockroachDB user and permissions to `600`. This prevents other users on the system from reading the key file.

3. **Distribution**  
   Transfer keys securely (e.g., via scp with correct permissions) to each node. Avoid email or other insecure channels.

4. **Regular Key Rotation**  
   Periodically rotate your encryption keys to limit exposure if a key were compromised.

5. **Monitoring**  
   Confirm encryption is functioning properly by using:
+
[source,bash]
----
cockroach debug encryption-status --host=<node_address> \
    --certs-dir=/path/to/certs
----
+
This reveals whether data is being encrypted and can highlight any configuration issues.

--

=== Key Rotation Process
[.text-left]
* Generate new encryption key
* Distribute new key to all nodes
* Configure old and new key paths
* Restart nodes sequentially
* Verify updated encryption status

[.notes]
--
Key rotation in CockroachDB is a seamless way to update your encryption keys without re-encrypting all existing data at once:

1. **Generate a New Key**  
+
[source,bash]
----
cockroach gen encryption-key --size=256 \
   --enterprise-encryption-key=path/to/aes-256.key
----
+

2. **Distribute the Key**  
   Securely copy the new key file to each node and maintain strict permissions.

3. **Configure Old and New Keys**  
   Start or restart each node with both `key` (the new key) and `old-key` (the current key) specified:
+
[source,bash]
----
cockroach start \
   --enterprise-encryption=path=/path/to/store,key=/path/to/aes-256.key,old-key=/path/to/aes-128.key \
   --certs-dir=/path/to/certs
----
+  

4. **Sequential Node Restarts**  
   By restarting one node at a time, you avoid cluster downtime. Writes handled by the node with the new key remain compatible with the old key until all nodes are updated.

5. **Verify Encryption Status**  
   Once all nodes have been restarted, use `cockroach debug encryption-status` to confirm the cluster is using the new key. Over time, newly written SSTs will be encrypted with the updated key.
--

=== Exercise Overview
[.text-left]
* Examine unencrypted storage patterns
* Implement encryption at rest
* Verify encryption effectiveness
* Perform key rotation
* Monitor encryption status

[.notes]
--
In this exercise, you will:

1. **Explore how data looks without encryption** by inspecting unencrypted SST files.  
2. **Enable encryption at rest**, setting up keys and configuring each CockroachDB node.  
3. **Verify encryption** via the command line and the Admin API to confirm data is no longer readable.  
4. **Perform a key rotation** to practice updating keys without disrupting the cluster.  
5. **Monitor encryption status** and ensure the transition is successful.

By the end, you’ll understand the steps needed to secure CockroachDB data at rest and manage encryption keys effectively in a production environment.
--
