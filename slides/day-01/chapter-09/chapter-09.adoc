== Load Balancing in CockroachDB
=== Why Load Balancing Matters
[.text-left]

* Distributes client traffic across multiple nodes
* Improves application performance and reliability
* Prevents single node overload
* Enables seamless node maintenance
* Provides fault tolerance for client connections

[.notes]
--
Load balancing is crucial for distributed databases like CockroachDB. It ensures that client requests are evenly distributed across all available nodes, preventing any single node from becoming a bottleneck. This distribution improves overall system performance and reliability while allowing node maintenance without disrupting active workloads.

Load balancers also provide fault tolerance: if a node becomes unhealthy, the load balancer directs traffic to other healthy nodes, minimizing downtime. By acting as a single entry point, the load balancer hides the underlying complexity of a multi-node cluster from client applications.
--

=== Load Balancer Architecture
[.text-left]

* Single entry point for all client connections
* Routes SQL traffic to healthy nodes
* Maintains persistent connections
* Monitors node health automatically
* Supports secure communication (TLS)

[.notes]
--
In CockroachDB deployments, the load balancer serves as the single entry point for client connections. It intelligently routes SQL traffic to nodes marked as healthy, maintaining long-lived TCP connections where possible for efficiency. Many load balancers (including HAProxy) can *actively* monitor node health by sending periodic pings or by checking cluster status endpoints. This automatic health checking ensures that any offline or slow node is temporarily removed from the active pool, preventing impact on application performance.

TLS support in the load balancer ensures end-to-end encryption. You can configure it for *SSL pass-through* (sending TLS directly to nodes) or *SSL termination* (where the load balancer decrypts traffic and re-encrypts when forwarding to CockroachDB).
--

=== HAProxy Configuration
[.text-left]

* Generated automatically by CockroachDB
* Includes all node endpoints
* Configures health checking
* Sets up TLS termination
* Defines balancing algorithm

[.notes]
--
CockroachDB provides built-in tools to generate HAProxy configuration, making deployment straightforward:

[source,bash]
----
cockroach gen haproxy --certs-dir=certs --host=node1
----

This command connects to the specified host (*node1*) and automatically discovers all node endpoints in the cluster, generating a comprehensive *haproxy.cfg*. It includes recommended health check intervals, frontend and backend definitions, and references to certificates if you’re using TLS. You can customize the default load balancing algorithm (e.g., *roundrobin*, *leastconn*) or health check settings as needed for production environments.
--

=== Load Balancer Deployment
[.text-left]

* Deploy configuration to HAProxy server
* Start/restart HAProxy service
* Verify service status
* Test connectivity through load balancer
* Monitor balanced connections

[.notes]
--
Deploying a load balancer typically involves:

1. Copying the *haproxy.cfg* to the HAProxy server, usually under */etc/haproxy/haproxy.cfg*.
2. Restarting or reloading HAProxy to apply the new settings:
+   
[source,bash]
----
sudo systemctl restart haproxy
----
+
3. Verifying *haproxy* is active:
+   
[source,bash]
----
systemctl status haproxy
----
+
4. Testing connectivity through the load balancer by connecting clients (or using `cockroach workload` or `cockroach sql`) to the *haproxy* host and port.

5. Monitoring the load balancer’s metrics (via HAProxy’s statistics page or logs) to confirm that connections are distributed evenly across the CockroachDB nodes.
--

=== Connection Management
[.text-left]

* Uses standard connection string format
* Supports TLS certificate authentication
* Maintains connection pools efficiently
* Handles connection failures gracefully
* Provides consistent addressing

[.notes]
--
Clients connect via a standard PostgreSQL connection string that includes SSL parameters. For example:

[source,bash]
----
postgresql://root@haproxy:26257?sslmode=verify-full
&sslcert=certs/client.root.crt
&sslkey=certs/client.root.key
&sslrootcert=certs/ca.crt
----

* *TLS Certificate Authentication:* CockroachDB can use certificate-based authentication, so the load balancer simply passes the encrypted traffic to the nodes or terminates SSL based on your configuration.
* *Connection Pools:* Many drivers or ORMs maintain internal connection pools. The load balancer further distributes these pooled connections across nodes, balancing workload as connections open and close.
* *Failure Handling:* If a node fails, the load balancer detects it and routes new connections to healthy nodes, keeping applications online and minimizing manual intervention.
--

=== Exercise Overview
[.text-left]

* Configure HAProxy for CockroachDB
* Deploy and verify load balancer
* Test with sample workload
* Validate balanced connections
* Monitor load balancer status

[.notes]
--
In the upcoming exercise, you will:

* Generate an HAProxy configuration using *cockroach gen haproxy* and review the contents of the resulting file.
* Deploy the configuration to the HAProxy server and restart the service.
* Test balanced connections by pointing a sample workload or the *cockroach sql* CLI at the HAProxy endpoint.
* Observe how client traffic is routed, validating that multiple CockroachDB nodes handle the load.
* Monitor the load balancer’s status and logs to confirm healthy connections and proper node distribution.

By the end, you’ll have a practical understanding of how load balancing integrates with CockroachDB’s distributed architecture, ensuring high availability and efficient resource use.
--